```
# Project Purpose
Logline is designed to provide a simple, efficient, and extensible mechanism for shipping log data from distributed nodes (e.g., Helix Network pendulum nodes) to a central log aggregation point. It aims to handle log rotation, notify operators via Telegram, and expose operational metrics to Prometheus, all while remaining lightweight enough to run in constrained environments.

# Key Concepts
- UDP log shipping
- Two‑threaded file tailing
- Log rotation handling
- Telegram notifications
- Prometheus metrics exporter
- Helix Network pendulum integration
- Docker deployment
- Centralized log server
- Python argparse
- File system monitoring

# Architecture Overview
Logline consists of three main components:

1. **Shipper** (`ship_log.py` / `pipe_log.py`) – A Python script that tails a specified log file or reads from stdin, spawns a background thread to monitor the file for new lines, and sends each line as a UDP packet to a configured host/port. It supports log rotation by re‑opening the file when its inode changes. The shipper also logs its own status and can send Telegram alerts on startup or when shipping stops.

2. **Receiver** (`receive_log.py`) – A lightweight UDP server that listens on a given port, writes incoming log lines to a destination file, and optionally prints them to stdout. It can be run behind NAT with proper port forwarding.

3. **Prometheus Exporter** (`prometheus_exporter/`) – A submodule that parses the log file for metrics relevant to the Helix pendulum node (e.g., block height, transaction counts). It exposes these metrics via an HTTP endpoint that Prometheus can scrape. The exporter uses context helpers, geo‑location utilities, and a results manager to aggregate data.

The system is orchestrated via Docker (planned) or directly from the command line. The README provides usage examples, and the tests cover log writing and context handling. The architecture is modular, allowing each component to be replaced or extended independently.

# Important Directories
- `alert_utilities`
- `grafana_dashboards`
- `prometheus_exporter`
- `tests`

# Entry Points
- `ship_log.py`
- `receive_log.py`
- `pipe_log.py`
- `kill_shipper.sh`

# Development Info
- **Dependencies** – Install with `pip install -r requirements.txt`.  
- **Running the exporter** – Execute `ship_log.py` to start shipping logs to the exporter, or `receive_log.py` to ingest logs directly.  
- **Testing** – Run `pytest` from the repository root to execute unit and integration tests.  
- **Dashboards** – Load the JSON files in `grafana_dashboards` into Grafana to view metrics.  
- **Development workflow** – Add new exporter logic under `prometheus_exporter`, write tests in `tests`, and update dashboards as needed.

# Usage Examples
## 1. Basic “default” run
```bash
# Tail /var/log/syslog and ship to 192.168.1.100:5140
logline --log-file /var/log/syslog --udp-host 192.168.1.100 --udp-port 5140
```

## 2. Using a configuration file
Create `logline.yaml`:
```yaml
log_file: /var/log/helix/pendulum.log
udp:
  host: 10.0.0.5
  port: 5140
telegram:
  token: "123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
  chat_id: "-987654321"
prometheus:
  port: 9100
```
Run:
```bash
logline --config logline.yaml
```

## 3. Enabling Telegram notifications for critical logs
```bash
logline \
  --log-file /var/log/helix/pendulum.log \
  --udp-host 10.0.0.5 \
  --udp-port 5140 \
  --telegram-token 123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11 \
  --telegram-chat-id -987654321 \
  --alert-pattern "ERROR|CRITICAL"
```

## 4. Exposing Prometheus metrics
```bash
logline \
  --log-file /var/log/helix/pendulum.log \
  --udp-host 10.0.0.5 \
  --udp-port 5140 \
  --prometheus-port 9100
```

## 5. Running inside Docker
```bash
docker run -d \
  --name logline \
  -v /var/log/helix:/var/log/helix \
  -v $(pwd)/logline.yaml:/etc/logline/logline.yaml \
  -p 9100:9100 \
  ghcr.io/yourorg/logline:latest \
  --config /etc/logline/logline.yaml
```

## 6. Systemd service unit (Linux)
Create `/etc/systemd/system/logline.service`:
```ini
[Unit]
Description=Logline Log Shipping Agent
After=network.target

[Service]
ExecStart=/usr/local/bin/logline --config /etc/logline/logline.yaml
Restart=on-failure
User=logline
Group=logline
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```
Enable and start:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now logline
```

## 7. Tail multiple files (advanced)
```bash
logline \
  --log-file /var/log/helix/pendulum.log \
  --log-file /var/log/helix/other.log \
  --udp-host 10.0.0.5 \
  --udp-port 5140
```

## 8. Custom log rotation handling
```bash
logline --log-file /var/log/helix/pendulum.log --force-rotate
```

## 9. Debug mode
```bash
logline --log-file /var/log/helix/pendulum.log --debug
```

## 10. Combining all features
```bash
logline \
  --config logline.yaml \
  --debug \
  --alert-pattern "WARN|ERROR|CRITICAL" \
  --prometheus-port 9100
```
```